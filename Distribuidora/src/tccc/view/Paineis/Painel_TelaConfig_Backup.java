/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package tccc.view.Paineis;

import java.awt.Component;
import java.awt.Window;
import java.io.File;
import java.sql.Connection;
import javax.swing.JFileChooser;
import javax.swing.JOptionPane;
import javax.swing.SwingUtilities;
import javax.swing.filechooser.FileNameExtensionFilter;
import tccc.Conexao;
import tccc.view.Menu;

/**
 *
 * @author Efraim
 */
public class Painel_TelaConfig_Backup extends javax.swing.JPanel {

    Process proc;
    Connection connection;

    Painel_TelaCliente CC;
    Painel_TelaFuncionario CFU;
    Painel_TelaProduto CPR;
    Painel_TelaFornecedor CFO;
    Painel_TelaEstoque CE;
    final JFileChooser JFC_Salvar_Backup = new JFileChooser();
    final JFileChooser JFC_Restaurar_Backup = new JFileChooser();

    public Painel_TelaConfig_Backup() {
        initComponents();
        connection = new Conexao().getConnection();

        JFC_Salvar_Backup.setVisible(false);
        JFC_Restaurar_Backup.setVisible(false);

        CC = new Painel_TelaCliente();
        CFU = new Painel_TelaFuncionario();
        CPR = new Painel_TelaProduto();
        CFO = new Painel_TelaFornecedor();
        CE = new Painel_TelaEstoque();
    }

    /**
     * This method is called from within the constructor to initialize the form.
     * WARNING: Do NOT modify this code. The content of this method is always
     * regenerated by the Form Editor.
     */
    @SuppressWarnings("unchecked")
    // <editor-fold defaultstate="collapsed" desc="Generated Code">//GEN-BEGIN:initComponents
    private void initComponents() {

        jPanel1 = new javax.swing.JPanel();
        Botao_BackupRealizar = new javax.swing.JPanel();
        jLabel9 = new javax.swing.JLabel();
        jLabel11 = new javax.swing.JLabel();
        Botao_BackupRestaurar = new javax.swing.JPanel();
        jLabel7 = new javax.swing.JLabel();
        jLabel8 = new javax.swing.JLabel();
        jLabel2 = new javax.swing.JLabel();
        jLabel3 = new javax.swing.JLabel();
        jLabel4 = new javax.swing.JLabel();
        jLabel5 = new javax.swing.JLabel();

        setBackground(new java.awt.Color(0, 153, 255));
        setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jPanel1.setBackground(new java.awt.Color(0, 153, 255));
        jPanel1.setBorder(javax.swing.BorderFactory.createTitledBorder(javax.swing.BorderFactory.createLineBorder(new java.awt.Color(255, 255, 255)), "Backup", javax.swing.border.TitledBorder.CENTER, javax.swing.border.TitledBorder.DEFAULT_POSITION, new java.awt.Font("Dialog", 1, 18), new java.awt.Color(255, 255, 255))); // NOI18N
        jPanel1.setForeground(new java.awt.Color(255, 255, 255));

        Botao_BackupRealizar.setBackground(new java.awt.Color(0, 0, 0));
        Botao_BackupRealizar.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                Botao_BackupRealizarMouseClicked(evt);
            }
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                Botao_BackupRealizarMouseEntered(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                Botao_BackupRealizarMouseExited(evt);
            }
        });
        Botao_BackupRealizar.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel9.setIcon(new javax.swing.ImageIcon(getClass().getResource("/tccc/Imagens/icons8_Add_Database_15px_1.png"))); // NOI18N
        Botao_BackupRealizar.add(jLabel9, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 0, -1, 40));

        jLabel11.setFont(new java.awt.Font("Trebuchet MS", 1, 18)); // NOI18N
        jLabel11.setForeground(new java.awt.Color(255, 255, 255));
        jLabel11.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel11.setText("Realizar");
        Botao_BackupRealizar.add(jLabel11, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 0, 90, 40));

        Botao_BackupRestaurar.setBackground(new java.awt.Color(0, 0, 0));
        Botao_BackupRestaurar.addMouseListener(new java.awt.event.MouseAdapter() {
            public void mouseClicked(java.awt.event.MouseEvent evt) {
                Botao_BackupRestaurarMouseClicked(evt);
            }
            public void mouseEntered(java.awt.event.MouseEvent evt) {
                Botao_BackupRestaurarMouseEntered(evt);
            }
            public void mouseExited(java.awt.event.MouseEvent evt) {
                Botao_BackupRestaurarMouseExited(evt);
            }
        });
        Botao_BackupRestaurar.setLayout(new org.netbeans.lib.awtextra.AbsoluteLayout());

        jLabel7.setIcon(new javax.swing.ImageIcon(getClass().getResource("/tccc/Imagens/icons8_Data_Backup_15px.png"))); // NOI18N
        Botao_BackupRestaurar.add(jLabel7, new org.netbeans.lib.awtextra.AbsoluteConstraints(10, 0, -1, 40));

        jLabel8.setFont(new java.awt.Font("Trebuchet MS", 1, 18)); // NOI18N
        jLabel8.setForeground(new java.awt.Color(255, 255, 255));
        jLabel8.setHorizontalAlignment(javax.swing.SwingConstants.CENTER);
        jLabel8.setText("Restaurar");
        Botao_BackupRestaurar.add(jLabel8, new org.netbeans.lib.awtextra.AbsoluteConstraints(30, 0, 90, 40));

        javax.swing.GroupLayout jPanel1Layout = new javax.swing.GroupLayout(jPanel1);
        jPanel1.setLayout(jPanel1Layout);
        jPanel1Layout.setHorizontalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(16, 16, 16)
                .addComponent(Botao_BackupRealizar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addPreferredGap(javax.swing.LayoutStyle.ComponentPlacement.RELATED, 135, Short.MAX_VALUE)
                .addComponent(Botao_BackupRestaurar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                .addGap(14, 14, 14))
        );
        jPanel1Layout.setVerticalGroup(
            jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.LEADING)
            .addGroup(jPanel1Layout.createSequentialGroup()
                .addGap(25, 25, 25)
                .addGroup(jPanel1Layout.createParallelGroup(javax.swing.GroupLayout.Alignment.TRAILING)
                    .addComponent(Botao_BackupRestaurar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE)
                    .addComponent(Botao_BackupRealizar, javax.swing.GroupLayout.PREFERRED_SIZE, javax.swing.GroupLayout.DEFAULT_SIZE, javax.swing.GroupLayout.PREFERRED_SIZE))
                .addContainerGap(35, Short.MAX_VALUE))
        );

        add(jPanel1, new org.netbeans.lib.awtextra.AbsoluteConstraints(230, 90, -1, -1));
        add(jLabel2, new org.netbeans.lib.awtextra.AbsoluteConstraints(930, 0, 80, 30));
        add(jLabel3, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 0, 80, 30));
        add(jLabel4, new org.netbeans.lib.awtextra.AbsoluteConstraints(0, 570, 80, 30));
        add(jLabel5, new org.netbeans.lib.awtextra.AbsoluteConstraints(930, 570, 80, 30));
    }// </editor-fold>//GEN-END:initComponents

    private void Botao_BackupRestaurarMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRestaurarMouseClicked
        try {
            JFC_Restaurar_Backup.addChoosableFileFilter(new FileNameExtensionFilter("Arquivos SQLs (*.sql)", "sql"));
            JFC_Restaurar_Backup.setSelectedFile(new File(""));
            JFC_Restaurar_Backup.setVisible(true);
            String bd = "projeto_tcc";
            int result = JFC_Restaurar_Backup.showOpenDialog(null);

            if (result == JFileChooser.OPEN_DIALOG) {

                File bkp;
                bkp = JFC_Restaurar_Backup.getSelectedFile();
                String arq = bkp.getPath();
                System.out.println("bd " + bd);
                System.out.println("arq " + arq);

                String[] cmd = new String[3];
                cmd[0] = "cmd.exe";
                cmd[1] = "/C";
                cmd[2] = System.getProperty("CaminhoBackup") + "/mysql.exe -u root -h localhost projeto_tcc < " + arq;
                Runtime rt = Runtime.getRuntime();
                System.out.println("Execing " + cmd[0] + " " + cmd[1]);
                proc = rt.exec(cmd);

                // any error message?
                StreamGobbler errorGobbler = new StreamGobbler(proc.getErrorStream(), "ERROR");

                // any output?
                StreamGobbler outputGobbler = new StreamGobbler(proc.getInputStream(), "OUTPUT");

                // kick them off
                errorGobbler.run();
                outputGobbler.run();

                // any error???
                int exitVal = proc.waitFor();

                if (exitVal == 0) {
                    JOptionPane.showMessageDialog(null, "Backup Restaurado com sucesso !");
                    try {
                        JOptionPane.showMessageDialog(null, "O sistema será reiniciado !!");
                        Component comp = SwingUtilities.getRoot(this);
                        ((Window) comp).dispose();
                        Menu mm = new Menu(1);
                        mm.setVisible(true);

                    } catch (Exception e) {
                        JOptionPane.showMessageDialog(null, e);
                    }
                } else {
                    JOptionPane.showMessageDialog(null, "Falha ao restaurar backup. \n Verifique as configurações ou entre em contato com o suporte !");
                }
            }

        } catch (Exception e) {
            JOptionPane.showMessageDialog(null, e, "Erro!", 2);
        }
        CC.ListarTabela();
        CFU.ListarTabela();
        CPR.ListarTabela();
        CFO.ListarTabela();
        CE.ListarTabela();
    }//GEN-LAST:event_Botao_BackupRestaurarMouseClicked

    private void Botao_BackupRestaurarMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRestaurarMouseEntered

    }//GEN-LAST:event_Botao_BackupRestaurarMouseEntered

    private void Botao_BackupRestaurarMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRestaurarMouseExited

    }//GEN-LAST:event_Botao_BackupRestaurarMouseExited

    private void Botao_BackupRealizarMouseClicked(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRealizarMouseClicked
        try {
            String arquivo = null;
            JFC_Salvar_Backup.setSelectedFile(new File(""));
            JFC_Salvar_Backup.setVisible(true);

            int result = JFC_Salvar_Backup.showSaveDialog(null);

            if (result == JFileChooser.APPROVE_OPTION) {
                arquivo = JFC_Salvar_Backup.getSelectedFile().toString().concat(".sql");

                File file = new File(arquivo);
                if (file.exists()) {
                    Object[] options = {"Sim", "Não"};
                    int opcao = JOptionPane.showOptionDialog(null, "Este arquivo já existe. Quer sobreescrever este arquivo?", "Atenção!!!",
                            JOptionPane.YES_NO_OPTION, JOptionPane.QUESTION_MESSAGE, null, options, options[0]);
                    if (opcao == JOptionPane.YES_OPTION) {
                        Runtime bck = Runtime.getRuntime();
                        bck.exec(System.getProperty("CaminhoBackup") + "mysqldump.exe -v -v -v --host=localhost --user=teste --password=123 --port=3306 --protocol=tcp --force --allow-keywords --compress  --add-drop-table --default-character-set=latin1 --hex-blob  --result-file=" + arquivo + " --databases projeto_tcc");
                        JOptionPane.showMessageDialog(null, "Backup realizado com sucesso.", "Tudo OK!", 1);
                        try {
                            JOptionPane.showMessageDialog(null, "O sistema será reiniciado !!");
                            Component comp = SwingUtilities.getRoot(this);
                            ((Window) comp).dispose();
                            Menu mm = new Menu(1);
                            mm.setVisible(true);

                        } catch (Exception e) {
                            JOptionPane.showMessageDialog(null, e);
                        }
                    } else {
                        Botao_BackupRealizarMouseClicked(evt);
                    }
                } else {

                    Runtime bck = Runtime.getRuntime();
                    bck.exec("C:/wamp64/bin/mysql/mysql5.7.19/bin/mysqldump.exe -v -v -v --host=localhost --user=teste --password=123 --port=3306 --protocol=tcp --force --allow-keywords --compress  --add-drop-table --default-character-set=latin1 --hex-blob  --result-file=" + arquivo + " --databases projeto_tcc");
                    JOptionPane.showMessageDialog(null, "Backup realizado com sucesso.", "Tudo OK!", 1);
                }
            }

        } catch (Exception e) {
            JOptionPane.showMessageDialog(null, e, "Erro!", 2);
        }
    }//GEN-LAST:event_Botao_BackupRealizarMouseClicked

    private void Botao_BackupRealizarMouseEntered(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRealizarMouseEntered
        // TODO add your handling code here:
    }//GEN-LAST:event_Botao_BackupRealizarMouseEntered

    private void Botao_BackupRealizarMouseExited(java.awt.event.MouseEvent evt) {//GEN-FIRST:event_Botao_BackupRealizarMouseExited
        // TODO add your handling code here:
    }//GEN-LAST:event_Botao_BackupRealizarMouseExited


    // Variables declaration - do not modify//GEN-BEGIN:variables
    private javax.swing.JPanel Botao_BackupRealizar;
    private javax.swing.JPanel Botao_BackupRestaurar;
    private javax.swing.JLabel jLabel11;
    private javax.swing.JLabel jLabel2;
    private javax.swing.JLabel jLabel3;
    private javax.swing.JLabel jLabel4;
    private javax.swing.JLabel jLabel5;
    private javax.swing.JLabel jLabel7;
    private javax.swing.JLabel jLabel8;
    private javax.swing.JLabel jLabel9;
    private javax.swing.JPanel jPanel1;
    // End of variables declaration//GEN-END:variables
}
